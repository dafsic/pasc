#PASC(private and security communication base ipv6)
## 不敢高声语，恐惊天上人。

------

###预计使用方法
> * pasc -c  ipv6地址   与具有此ipv6地址的人开始一个会话
> * pasc -l  [name] 用户登陆,即开始监听12341端口

### 设计缘由
人们平时通过通信软件与不在身边的朋友或者合作伙伴交流的时候，尤其是私密或者重要的谈话，一定希望他们的谈话内容是安全的。这是一个正当且合理的要求，因为每个公民都有言论自由和隐私权，任何人都不应该被非法监控。所谓的安全需要两方面保证，一是要保证他们的谈话内容只在他们之间传输，而不是在去某地的服务器或第三者绕一圈。我们不信任第三者，也不希望谈话数据保存在我们不能绝对控制的地方。二是要保证即使被有心人截获之后也无法得知他们的通话内容。第一方面的保证需要的是一个点对点的通信程序，第二方面需要的就是要对谈话内容进行加密。又由于ipv4地址的枯竭，和ipv4对网络端到端的特性的破坏，ipv6迟早要取ipv4而代之。

------

### 预期功能
此工具能在不需要任何第三方的情况下，以点对点的方式与对方建立可靠的连接。连接开始要互相验证身份，通过验证后，可以进行通信。并且通行内容应该被加密传输，对方收到消息后，解密，验证数据的完整性。验证完成后，输出到界面。

-------

### 设计方案

####协议的选择

在现在的网络空间中，要实现点对点的连接，要么有公网的ipv4地址，要么需要第三方做协调者，通过udp打洞技术实现内网穿透。显然公网ipv4地址是不现实的，udp打洞技术又需要提供一个公网服务器做协调，而且udp链接是不可靠的。tcp内网穿透又因为设备的不支持无法广泛使用。所以这里使用ipv6建立tcp连接的方法。

####加密方式和身份验证方式的选择

考虑加密方式有对称加密和非对称加密，如果只用非对称加密算法加密，即把公钥公开出去，传输数据时用对方的公钥对数进行加密，对方收到后用自己的私钥解密。但是有两个问题，一是非对称加密算法比较复杂，对少量数据加密尚可，对大量数据加密效率就太低了，也因此非对称加密通常用来传输对称加密的密钥，用对称加密算法对数据进行加密。二是这种方法公钥也可能被人非法替换，导致中间人攻击，所以每个人都要到CA去认证，这个相比起来就显得麻烦，而且很不必要。况且认证中心也未必可靠。
这里以暗号口令的方式进行认证，用对称加密算法加密。暗号分上下两句，暗号的传递是通过其他方式进行的，比如电话，短信，邮件等。认证过程是这样的：发送方用明文发送暗号的上句，接受方收到后输入暗号的下句，但不发送任何消息给发送方，这只是我们不发送，tcp协议在接受到数据后自然会发送ack报文，这个我们不管。发送方用暗号下句加密一个随机数发送出去，接受方接受之后，用暗号下句进行解密，把随机数加一，加密发送给对方。发送方收到加一的数后，验证是否正确，如果正确，再加一发送，并开始通话，不符合则断开连接。接受方接收到这个加二的数据后，也进行验证，验证通过则开启通话，失败则关闭连接。整个过程，用来加密数据的暗号下句一直都是存储在本地，不会出现在网络中。
一直以来，密钥的传输和保管都是棘手的问题。这里采用的方式使得密钥的保管不再是问题，因为我们在每次建立连接的时候都要输入暗号，所以我们根本就不需要记住任何密码，所以也就无需保管任何密码。而且这相当是一次一密的加密方式，因此通信的数据的安全性取决于暗号下句的安全性。
这样的验证方式是类似tcp的三次握手。

--------

### 设计理念
此程序为P2P模型，摒弃了以服务器为中心的C/S模型，让网络上所有主机重新回归到对等的地位。P2P模型使得每台机器在消耗服务的同时也给别人提供服务。但是这种模型存在一个显著的问题，即主机之间很难互相发现。我们可以开发一个发现服务器来提供主机发现的功能，但是用户有权利选择注册或者不注册，注册是为了别人更方便的找到自己。但是这个发现服务器还没有开发，有兴趣的欢迎加入。这里没有设置管理好友的功能也是经过慎重思考之后的决定。因为此软件的定位不是为了普通的闲话聊天，这样，我们假设如果别人得到了你的密码，他也无法得知你的好友或者合作伙伴。也是因为此，我们把通话记录的功能也去掉了，这样既保证了一定的安全，又使软件变得简单，保证用户不用花费时间去学习命令行的使用。如果是闲聊的话应该考虑其他有更加友好界面的软件。

------
### 协议结构
 len     | md5 |  data  
:--------   | :-----  | :----  
 13 |a2edfrJilicD4@vi |talk is cheap
16|feocqw83l#fVwozK|show me the code

------
###相关知识
> * 本地链路地址只用于本地链路范围,不能在站点内的子网间路由（fe80::)
> * 站点本地地址类似与ipv4的内网的概念(fec0::)
> * 当指定AF_INET6时，如果用链路本地地址，在connect时会出现Invalid argument错误
> * 站点本地地址则可以
> * service iptables stop centos6关闭防火墙
> * systemctl stop firewalld centos7关闭防火墙
> * ifconfig eth0:1 inet6 add fec0::3/64添加站点本地地址
> * ping6 -I eth0 fec0::3  检测主机是否可达
> * netstat -ant 查看tcp端口
> * tcpdump -nt -X -i eth0 'src fec0::3 || dst fec0::3'抓包

